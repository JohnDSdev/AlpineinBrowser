<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Alpine Browser VM (Offline)</title>
  <style>
    :root {
      --bg: #f6f3ed;
      --ink: #1f2933;
      --muted: #66717d;
      --card: #fffdf9;
      --line: #d6d0c4;
      --accent: #0d6b4d;
      --accent-2: #e7f4ed;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      color: var(--ink);
      background:
        radial-gradient(circle at 20% -10%, #fffaf1 0%, transparent 45%),
        radial-gradient(circle at 100% 0%, #dff2e8 0%, transparent 55%),
        var(--bg);
      font-family: "Source Sans 3", "Trebuchet MS", Verdana, sans-serif;
    }

    .wrap {
      max-width: 1140px;
      margin: 0 auto;
      padding: 18px;
    }

    h1 {
      margin: 0;
      font-size: 2rem;
      letter-spacing: 0.02em;
    }

    .subtitle {
      margin: 8px 0 16px;
      color: var(--muted);
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }

    button {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--card);
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
      color: var(--ink);
    }

    button.primary {
      background: var(--accent);
      color: #ffffff;
      border-color: #0a523b;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status {
      padding: 9px 12px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: var(--accent-2);
      color: #0f513a;
      font-size: 0.95rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.45fr 0.9fr;
      gap: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 24px rgba(39, 34, 24, 0.08);
    }

    .head {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      background: #fff9ef;
      font-weight: 600;
    }

    .body {
      padding: 12px;
    }

    #screen {
      width: 100%;
      aspect-ratio: 4 / 3;
      min-height: 360px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #222;
    }

    #screen canvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
      image-rendering: pixelated;
    }

    #serial {
      height: 420px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      background: #0c1117;
      color: #dde4ed;
      border: 1px solid #243040;
      border-radius: 8px;
      padding: 10px;
      font-family: "Cascadia Mono", "Consolas", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.3;
    }

    #log {
      height: 170px;
      overflow: auto;
      white-space: pre-wrap;
      font-family: "Cascadia Mono", "Consolas", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.3;
      color: #203040;
      background: #f4efe3;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px;
    }

    .tip {
      margin: 0 0 10px;
      color: var(--muted);
      font-size: 0.94rem;
      line-height: 1.35;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }

      #screen {
        min-height: 300px;
      }
    }
  </style>
  <script src="assets/js/libv86.js"></script>
  <script src="assets/js/vm-assets.js"></script>
</head>
<body>
  <main class="wrap">
    <h1>Alpine Linux in One HTML File</h1>
    <p class="subtitle">Fully local: no external network calls. Open this file, then click start.</p>

    <div class="toolbar">
      <button id="start" class="primary">Start Alpine VM</button>
      <button id="restart" disabled>Restart VM</button>
      <span class="status" id="status">Idle</span>
    </div>

    <div class="grid">
      <section class="card">
        <div class="head">
          <span>VGA Console</span>
          <span>Click inside to focus</span>
        </div>
        <div class="body">
          <p class="tip">Use this panel for normal Alpine interaction. Login is usually <code>root</code> (no password).</p>
          <div id="screen"></div>
        </div>
      </section>

      <section class="card">
        <div class="head">
          <span>Serial Output</span>
          <span>Read-only mirror</span>
        </div>
        <div class="body">
          <div id="serial"></div>
        </div>
      </section>

      <section class="card" style="grid-column: 1 / -1;">
        <div class="head">
          <span>Boot Log</span>
          <span>Troubleshooting</span>
        </div>
        <div class="body">
          <div id="log"></div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const CONFIG = {
      memory_size: 512 * 1024 * 1024,
      vga_memory_size: 8 * 1024 * 1024,
      disable_speaker: true,
      autostart: true
    };

    const startButton = document.getElementById("start");
    const restartButton = document.getElementById("restart");
    const statusEl = document.getElementById("status");
    const screenEl = document.getElementById("screen");
    const serialEl = document.getElementById("serial");
    const logEl = document.getElementById("log");

    let vm = null;
    let decodedAssets = null;

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i += 1) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    }

    function getDecodedAssets() {
      if (decodedAssets) {
        return decodedAssets;
      }

      log("Decoding local VM assets into memory...");
      decodedAssets = {
        wasm: base64ToArrayBuffer(window.VM_ASSETS_B64.wasm),
        bios: base64ToArrayBuffer(window.VM_ASSETS_B64.bios),
        vgabios: base64ToArrayBuffer(window.VM_ASSETS_B64.vgabios),
        iso: base64ToArrayBuffer(window.VM_ASSETS_B64.alpine_iso)
      };
      log("Local assets decoded.");
      return decodedAssets;
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function log(text) {
      logEl.textContent += text + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    function serialWrite(ch) {
      serialEl.textContent += ch;
      serialEl.scrollTop = serialEl.scrollHeight;
    }

    async function startVm() {
      if (typeof V86 === "undefined" || typeof window.VM_ASSETS_B64 === "undefined") {
        setStatus("Failed");
        log("Required local scripts did not load (libv86.js or vm-assets.js).");
        return;
      }

      startButton.disabled = true;
      setStatus("Starting");
      log("Preparing Alpine VM...");

      if (vm) {
        try {
          vm.stop();
        } catch (error) {
          log("Warning stopping previous VM: " + error.message);
        }
        vm = null;
      }

      screenEl.replaceChildren();
      serialEl.textContent = "";

      try {
        const assets = getDecodedAssets();

        vm = new V86({
          ...CONFIG,
          wasm_fn: function(imports) {
            return WebAssembly.instantiate(assets.wasm, imports).then(function(result) {
              return result.instance.exports;
            });
          },
          bios: { buffer: assets.bios.slice(0) },
          vga_bios: { buffer: assets.vgabios.slice(0) },
          cdrom: { buffer: assets.iso.slice(0) },
          screen_container: screenEl
        });

        vm.add_listener("emulator-ready", function() {
          setStatus("Running");
          restartButton.disabled = false;
          log("Alpine VM is running.");
        });

        vm.add_listener("download-progress", function(e) {
          if (!e || !e.file_name) {
            return;
          }
          const pct = e.total ? Math.floor((e.loaded / e.total) * 100) : 0;
          setStatus("Downloading " + pct + "%");
        });

        vm.add_listener("serial0-output-byte", function(b) {
          serialWrite(String.fromCharCode(b));
        });

        log("Booting Alpine from bundled local ISO...");
      } catch (error) {
        setStatus("Failed");
        startButton.disabled = false;
        log("Failed to start VM: " + error.message);
      }
    }

    startButton.addEventListener("click", startVm);
    restartButton.addEventListener("click", function() {
      setStatus("Restarting");
      log("Restart requested...");
      startVm();
    });

    log("Ready. Click Start Alpine VM.");
    log("This build is fully local and does not call external hosts at runtime.");
  </script>
</body>
</html>
